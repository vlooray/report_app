# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FEAWS5v8AAblXHa7VXEhWKkzU_PX5AkV
"""

import streamlit as st
import pandas as pd
import datetime

st.set_page_config(page_title="Wavepick Monitoring", layout="wide")
st.title("\U0001F50D Wavepick Monitoring - Zona Overview")

uploaded_file = st.file_uploader("Upload file Excel", type=["xlsx", "xls"])

# Load referensi zona dari file lokal
try:
    df_zona = pd.read_excel("referensi_zona.xlsx", sheet_name="Zona")
    df_zona_ps1 = pd.read_excel("referensi_zona.xlsx", sheet_name="Zona PS1")
except Exception as e:
    st.error(f"Gagal load data referensi zona: {e}")
    st.stop()

if uploaded_file:
    try:
        if uploaded_file.name.endswith(".xls"):
            df_raw = pd.read_excel(uploaded_file, sheet_name=0, engine="xlrd")
        else:
            df_raw = pd.read_excel(uploaded_file, sheet_name=0)
    except Exception as e:
        st.error(f"Gagal baca sheet dari file user: {e}")
        st.stop()

    df = df_raw.copy()
    df.columns = df.columns.str.strip()

    column_mapping = {
        'Confirm Date': 'Confirm date',
        'Confirm Time': 'Confirm time',
        'Qty': 'Qty',
        'Flag': 'Flag',
        'Wavepick Created': 'Wavepick created',
        'Wavepick No': 'Wavepick',
        'Stype': 'STYPE',
        'Material ID': 'MID',
        'Description': 'Description'
    }
    df = df.rename(columns=column_mapping)

    required_columns = list(column_mapping.values())
    missing_columns = [col for col in required_columns if col not in df.columns]
    if missing_columns:
        st.error(f"File yang diupload tidak mengandung kolom berikut: {', '.join(missing_columns)}")
        st.stop()

    df['Confirm date'] = pd.to_datetime(df['Confirm date'], errors='coerce')
    df['Confirm time'] = pd.to_datetime(df['Confirm time'], errors='coerce')
    df['Wavepick created'] = pd.to_datetime(df['Wavepick created'], errors='coerce')

    stype_to_zona = df_zona.groupby('STYPE')['ZONA'].first().to_dict()

    df['ZONA'] = df['STYPE'].map(stype_to_zona)
    df = df.merge(df_zona_ps1, on='MID', how='left', suffixes=('', '_ps1'))
    df['ZONA'] = df['ZONA_ps1'].combine_first(df['ZONA'])
    df = df.drop(columns=['ZONA_ps1'])

    zona_map = {
        'ZAA': 'A',
        'ZAB': 'BK',
        'ZAC': 'CJ',
        'ZAL': 'L'
    }
    df['ZONA'] = df['ZONA'].replace(zona_map)
    df['ZONA'] = df['ZONA'].fillna('Unmapped')

    # ZONA SUMMARY - MONITORING
    df_monitor = df[(df['Qty'] > 0) & (df['Flag'] == 'A') & (~df['ZONA'].isin(['Unmapped', 'Unnamed']))].copy()

    # Filter wavepick dengan box < 100 dan material ID < 5
    wavepick_filter = df_monitor.groupby('Wavepick').agg(
        Total_Qty=('Qty', 'sum'),
        Total_MID=('MID', 'nunique')
    )
    wavepick_valid = wavepick_filter[(wavepick_filter['Total_Qty'] >= 100) & (wavepick_filter['Total_MID'] >= 5)].index
    df_monitor = df_monitor[df_monitor['Wavepick'].isin(wavepick_valid)]

    zona_summary = df_monitor.groupby('ZONA').agg(
        Jumlah_Wavepick=('Wavepick', 'nunique'),
        Total_Qty=('Qty', 'sum'),
        Total_Material_ID=('MID', 'nunique')
    ).reset_index()

    st.subheader("\U0001F4CB Tabel Monitoring per Zona (Flag A)")
    st.dataframe(zona_summary, use_container_width=True)

    # MENU ALERT UNTUK STYPE RB1 YANG BELUM DIPICK
    st.subheader("\U0001F6A8 Item 'Belum Dipick Operator' - STYPE RB1")
    rb1_alert = df[(df['STYPE'] == 'RB1') & (df['Flag'] == 'A')]
    if not rb1_alert.empty:
        rb1_alert = rb1_alert[['Wavepick', 'MID', 'Description', 'Qty', 'ZONA']]
        st.dataframe(rb1_alert.sort_values(by='Wavepick'), use_container_width=True)
    else:
        st.info("Tidak ada item STYPE RB1 yang belum dipick.")

    # TABEL WAVEPICK DAN DURASI LIVE + MID YANG BELUM DI-SCAN
    df_valid = df[(df['Qty'] > 0) & (~df['ZONA'].isin(['Unmapped', 'Unnamed']))].copy()
    df_valid['TimeStr'] = df_valid['Confirm time'].dt.time.astype(str)
    valid_confirm = df_valid[(df_valid['Confirm time'].notna()) & (df_valid['TimeStr'] != '00:00:00')]

    wavepick_group = valid_confirm.groupby('Wavepick')['Confirm time'].min().reset_index(name='1st Confirm Time')
    wavepick_group['Current Time'] = pd.Timestamp.now()
    wavepick_group['Duration'] = wavepick_group['Current Time'] - wavepick_group['1st Confirm Time']
    wavepick_group['Duration'] = wavepick_group['Duration'].apply(lambda x: str(x).split('.')[0])

    st.subheader("‚è±Ô∏è Durasi Picking per Wavepick (Live)")
    st.dataframe(wavepick_group, use_container_width=True)

    st.subheader("üì¶ Material ID Belum Di-confirm per Wavepick")
    mid_unscanned = df_valid[df_valid['Flag'] == 'A']
    mid_unscanned = mid_unscanned[['Wavepick', 'MID', 'Description', 'Qty', 'ZONA']]
    st.dataframe(mid_unscanned.sort_values(by='Wavepick'), use_container_width=True)

else:
    st.info("Silakan upload file Excel untuk mulai.")