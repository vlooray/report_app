# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FEAWS5v8AAblXHa7VXEhWKkzU_PX5AkV
"""

# app.py
import streamlit as st
import pandas as pd
from io import BytesIO

st.set_page_config(page_title="Wavepick Late Checker", layout="centered")

st.title("ðŸ“¦ Wavepick Late Recap")
st.write("Upload file Excel mentah lo, dan sistem bakal hitung wavepick yang terlambat per STYPE.")

uploaded_file = st.file_uploader("Upload file .xlsx", type=["xlsx"])

if uploaded_file:
    # Load Excel
    xls = pd.ExcelFile(uploaded_file)
    df = xls.parse("Worksheet")

    # Convert necessary fields
    df['Wavepick Created'] = pd.to_datetime(df['Wavepick Created'], errors='coerce')
    df['Confirm Date'] = pd.to_datetime(df['Confirm Date'], errors='coerce')
    df['Confirm Time'] = pd.to_timedelta(df['Confirm Time'], errors='coerce')
    df['Confirm Datetime'] = df['Confirm Date'] + df['Confirm Time']

    # Filter late wavepicks
    mask_late = (
        (df['Qty'] > 0) &
        (df['Flag'] == 'A') &
        (df['Confirm Datetime'].isna())
    )
    late_df = df[mask_late]

    # Count unique wavepicks per STYPE
    count_df = late_df.groupby('Stype')['Wavepick No'].nunique().reset_index()
    count_df.columns = ['STYPE', 'Wavepick Late']

    st.subheader("ðŸ“Š Hasil Rekap:")
    st.dataframe(count_df)

    # Download option
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Worksheet')
        count_df.to_excel(writer, index=False, sheet_name='Count')
    output.seek(0)

    st.download_button(
        label="ðŸ“¥ Download Hasil Excel",
        data=output,
        file_name="wavepick_recap.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )