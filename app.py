# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FEAWS5v8AAblXHa7VXEhWKkzU_PX5AkV
"""

import streamlit as st
import pandas as pd

st.set_page_config(page_title="Wavepick Late Checker", layout="wide")
st.title("\U0001F4E6 Wavepick Late Checker - Zona View")

uploaded_file = st.file_uploader("Upload file Excel", type=["xlsx", "xls"])

# Load referensi zona dari file lokal (file internal dev)
try:
    df_zona = pd.read_excel("referensi_zona.xlsx", sheet_name="Zona")
    df_zona_ps1 = pd.read_excel("referensi_zona.xlsx", sheet_name="Zona PS1")
except Exception as e:
    st.error(f"Gagal load data referensi zona: {e}")
    st.stop()

if uploaded_file:
    try:
        if uploaded_file.name.endswith(".xls"):
            df_raw = pd.read_excel(uploaded_file, sheet_name=0, engine="xlrd")
        else:
            df_raw = pd.read_excel(uploaded_file, sheet_name=0)
    except Exception as e:
        st.error(f"Gagal baca sheet dari file user: {e}")
        st.stop()

    # Filter kondisi "late"
    df = df_raw.copy()

    # Normalisasi nama kolom
    df.columns = df.columns.str.strip()

    # Normalisasi dan rename kolom agar sesuai format user
    column_mapping = {
        'Confirm Date': 'Confirm date',
        'Confirm Time': 'Confirm time',
        'Qty': 'Qty',
        'Flag': 'Flag',
        'Wavepick Created': 'Wavepick created',
        'Wavepick No': 'Wavepick',
        'Stype': 'STYPE',
        'Material ID': 'MID'
    }
    df = df.rename(columns=column_mapping)

    required_columns = list(column_mapping.values())
    missing_columns = [col for col in required_columns if col not in df.columns]
    if missing_columns:
        st.error(f"File yang diupload tidak mengandung kolom berikut: {', '.join(missing_columns)}")
        st.stop()

    df['Confirm date'] = pd.to_datetime(df['Confirm date'], errors='coerce')
    df['Confirm time'] = pd.to_datetime(df['Confirm time'], errors='coerce').dt.time
    df['Wavepick created'] = pd.to_datetime(df['Wavepick created'], errors='coerce')

    df_late = df[(df['Qty'] > 0) & (df['Flag'] == 'A') & (df['Confirm time'].astype(str) == '00:00:00')]

    # Map ZONA (gabungan STYPE)
    stype_to_zona = df_zona.groupby('STYPE')['ZONA'].first().to_dict()
    df_late['ZONA'] = df_late['STYPE'].map(stype_to_zona)

    # Handle STYPE = PS1 yang pakai MID
    df_late = df_late.merge(df_zona_ps1, on='MID', how='left', suffixes=('', '_ps1'))

    # Prioritaskan mapping dari Zona PS1 (MID-based) jika ada
    df_late['ZONA'] = df_late['ZONA_ps1'].combine_first(df_late['ZONA'])
    df_late = df_late.drop(columns=['ZONA_ps1'])

    # Mapping ulang jika hasil MID ada di zona gabungan
    zona_map = {
        'ZAA': 'A',
        'ZAB': 'BK',
        'ZAC': 'CJ',
        'ZAL': 'L'
    }
    df_late['ZONA'] = df_late['ZONA'].replace(zona_map)

    # Isi NaN ZONA sebagai 'Unmapped'
    df_late['ZONA'] = df_late['ZONA'].fillna('Unmapped')

    # Hitung jumlah wavepick unik per zona (tanpa Unmapped dan Unnamed)
    zona_summary = df_late[~df_late['ZONA'].isin(['Unmapped', 'Unnamed'])].groupby('ZONA')['Wavepick'].nunique().reset_index()
    zona_summary.columns = ['ZONA', 'Jumlah Wavepick Late']
    zona_summary = zona_summary.sort_values(by='Jumlah Wavepick Late', ascending=False)

    st.subheader("\U0001F4CA Ringkasan Wavepick Late per ZONA")
    st.dataframe(zona_summary, use_container_width=True)

    st.bar_chart(zona_summary.set_index('ZONA'))

    # Highlight data late >6 jam
    df_late['late_diff'] = (df_late['Confirm date'] - df_late['Wavepick created'])
    df_late['late_diff_hour'] = df_late['late_diff'].dt.total_seconds() / 3600
    df_warn = df_late[df_late['late_diff_hour'] > 6]

    if not df_warn.empty:
        st.warning(f"\U0001F6A8 Ada {len(df_warn)} wavepick yang telat lebih dari 6 jam!")
        with st.expander("Lihat detail wavepick telat >6 jam"):
            st.dataframe(df_warn[['Wavepick', 'ZONA', 'STYPE', 'MID', 'late_diff_hour']], use_container_width=True)
else:
    st.info("Silakan upload file Excel untuk mulai.")